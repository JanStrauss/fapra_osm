<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>OSM Routing</title>
	<link rel="stylesheet" href="leaflet.css"/>
	<link rel="stylesheet" href="style.css"/>
	<script src="leaflet.js"></script>
	<script src="jquery-3.0.0.min.js"></script>
</head>

<body>
<div id="osm_map"></div>
<div id="sidebar">
	<form id="routing_form" action="api/route" method="get">
		<label for="source">Source:</label>
		<input type="text" id="source" name="source" value="1133751511"/><br/>

		<label for="target">Target:</label>
		<input type="text" id="target" name="target" value="27281797"/><br/>

		<label for="vehicle">Vehicle:</label>
		<select id="vehicle" name="vehicle">
			<option value="car">Car</option>
			<option value="bike">Bike</option>
			<option value="walk">Walk</option>
		</select><br/>

		<label for="metric">Metric:</label>
		<select id="metric" name="metric">
			<option value="distance">Distance</option>
			<option value="time">Time</option>
		</select><br/>

		<input type="submit" id="submitButton" name="submitButton" value="Submit">
	</form>

	<div id="result_distance"></div>
	<div id="result_time"></div>
	<div id="result_duration"></div>
</div>

<script>

	var target_icon = L.icon({
		iconUrl: 'images/marker-icon2.png',
		iconRetinaUrl: 'images/marker-icon2.png',
		iconSize: [25, 41],
		iconAnchor: [12, 41],
		popupAnchor: [1, -34],
		shadowUrl: 'images/marker-shadow.png',
		shadowRetinaUrl: 'images/marker-shadow.png',
		shadowSize: [41, 41],
	});

	var mymap = L.map('osm_map').setView([48.7836043, 9.1821771], 8);
	var route;
	var source;
	var source_marker;
	var target;
	var target_marker;

	var toggle = true;

	L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
		maxZoom: 18,
		attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
		'<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>'
	}).addTo(mymap);

	function onMapClick(e) {
		if (toggle) {
			if (source_marker != null) {
				mymap.removeLayer(source_marker);
			}
			source = e.latlng;
			$('#source').val(source.lat + "," + source.lng);
			source_marker = L.marker(source);
			source_marker.addTo(mymap);
		} else {
			if (target_marker != null) {
				mymap.removeLayer(target_marker);
			}
			target = e.latlng;
			$('#target').val(target.lat + "," + target.lng);
			target_marker = L.marker(target, {icon: target_icon});
			target_marker.addTo(mymap);
		}
		toggle = !toggle;
	}

	mymap.on('click', onMapClick);

	$("#routing_form").submit(function (event) {

		event.preventDefault();

		var $form = $(this);
		var url = $form.attr('action');

		$.getJSON(url, {
			source: $('#source').val(),
			target: $('#target').val(),
			vehicle: $('#vehicle').val(),
			metric: $('#metric').val()
		}, function (result) {
			//console.log(result);

			if (route != null) {
				mymap.removeLayer(route);
			}

			var new_route = L.polyline(result.route.path);
			new_route.addTo(mymap);

			$('#result_distance').html("travel distance: " + result.route.distance / 1000.0 + "km");
			$('#result_time').html("travel time: " + result.route.time / 60.0 + "min");
			$('#result_duration').html("route calculation took " + result.duration + "ms.");

			route = new_route;
		});
	});

</script>
</body>

</html>